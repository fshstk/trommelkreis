{% extends "layout.html" %}
{% load session_filters %}

{% block title %}Challenge vom {{ session|dateformat }}{% endblock %}
{% block heading %}{{ session.challenge.name }}{% endblock %}
{% block subheading %}{{ session|dateformat }}{% endblock %}

{% block main %}
<div class="card">
  <div class="card-body">
    <div id="challenge-description">
      {{ session.challenge.description|markdownify|safe }}
    </div>
  </div>
</div>
<hr>
{% for subsection in files %}
{% if subsection.0.session_subsection %}
<h3>{{ subsection.0.session_subsection }}</h3>
{% endif %}
<div id="sessionlist" class="list-group text-start">
  {% for file in subsection %}
  {% if file.filesize == 0 %}
  <a href="#" class="list-group-item disabled bg-secondary">
    <div class="d-flex justify-content-between"><h5 class="mb-1 text-truncate text-white">{{ file.name }}</h5></div>
    <div class="d-flex justify-content-between">
      <p class="mb-1 text-truncate text-white">{{ file.artist|default:"Anonym" }}</p>
      <small class="text-warning">verloren</small>
    </div>
  </a>
  {% else %}
  <a href="#{{ file.slug|css_friendly_id }}" class="list-group-item list-group-item-action" data-bs-toggle="collapse">
    <div class="d-flex justify-content-between">
      <h5 class="mb-1 text-truncate">{{ file.name }}</h5>
      <small class="text-muted">{{ file|duration }}</small>
    </div>
    <div class="d-flex justify-content-between">
      <p class="mb-1 text-muted text-truncate">{{ file.artist|default:"Anonym" }}</p>
      <small class="text-muted">{{ file.filesize|filesizeformat }}</small>
    </div>
  </a>
  <div class="collapse" id="{{ file.slug|css_friendly_id }}" data-bs-parent="#sessionlist">
    <div class="card card-body">
      <audio src="{{ file.url }}" style="width: 100%;" preload="none" controls>
        <p>Dein browser unterst√ºtzt das <em>audio</em> Element nicht.</p>
        <p>Du kannst stattdessen die <a href="{{ file.url }}">Datei Herunterladen</a>.</p>
      </audio>
    </div>
    <hr>
  </div>
  {% endif %}
  {% endfor %}
</div>
<hr>
{% endfor %}
<div class="d-flex justify-content-between">
  <span><a href="{% url 'archive:index' %}" class="text-decoration-none">Archiv</a> / <a href="{% url 'archive:sessions' %}" class="text-decoration-none">Sessions</a> / {{ session.slug }}</span>
</div>
{% endblock %}

{% block scripts %}
<script>
$(() => {
  $(".collapse").each((index, element) => {
    let player = $(element).find("audio")[0];
    $(element).on("hidden.bs.collapse", () => player.pause());
  });
});
</script>
{% endblock %}
